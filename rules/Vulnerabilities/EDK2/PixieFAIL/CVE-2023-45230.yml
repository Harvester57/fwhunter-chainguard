CVE-2023-45230:
  meta:
    author: Binarly (https://github.com/binarly-io/FwHunt)
    license: CC0-1.0
    name: CVE-2023-45230
    namespace: vulnerabilities
    advisory: https://blog.quarkslab.com/pixiefail-nine-vulnerabilities-in-tianocores-edk-ii-ipv6-network-stack.html
    description: Buffer overflow in the DHCPv6 client via a long Server ID option
    CVSS score: 8.3 High
    architecture: X86:LE:64
    tags:
      - kind: sdk
        value: EDK2
    volume guids:
      - 95E3669D-34BE-4775-A651-7EA41B69D89E
  variants:
    variant1:
      code:
        and:
          - pattern: 488b4424..4883c0..48894424..488b8424........488b40..8b40..48394424..73..488b8c24........488b49..488b49..488b4424..488b04c10fb748..e8........0fb7c88b8424........8d4408..898424........eb..8b8424........05........8bc8e8
              # 488b442430                          mov     rax, [rsp+98h+var_68]
              # 4883c001                            add     rax, 1
              # 4889442430                          mov     [rsp+98h+var_68], rax
              # 488b8424a0000000                    mov     rax, [rsp+98h+arg_0]
              # 488b4078                            mov     rax, [rax+78h]
              # 8b4010                              mov     eax, [rax+10h]
              # 4839442430                          cmp     [rsp+98h+var_68], rax
              # 7339                                jnb     short loc_4CC7
              # 488b8c24a0000000                    mov     rcx, [rsp+98h+arg_0]
              # 488b4978                            mov     rcx, [rcx+78h]
              # 488b4918                            mov     rcx, [rcx+18h]
              # 488b442430                          mov     rax, [rsp+98h+var_68]
              # 488b04c1                            mov     rax, [rcx+rax*8]
              # 0fb74802                            movzx   ecx, word ptr [rax+2]
              # e860590000                          call    NTOHS
              # 0fb7c8                              movzx   ecx, ax
              # 8b842480000000                      mov     eax, [rsp+98h+UserLen]
              # 8d440804                            lea     eax, [rax+rcx+4]
              # 89842480000000                      mov     [rsp+98h+UserLen], eax
              # eba3                                jmp     short loc_4C6A
              # 8b842480000000                      mov     eax, [rsp+98h+UserLen]
              # 0500040000                          add     eax, 400h
              # 8bc8                                mov     ecx, eax; AllocationSize
              # e846620000                          call    AllocateZeroPool
          - pattern: 488b4424..0fb708e8........66894424..488b5c24..4883c3..66b9....e8........4c8bcb440fb74424..0fb7d0488b4c24..e8
              # 488b442440                          mov     rax, [rsp+98h+var_58]
              # 0fb708                              movzx   ecx, word ptr [rax]
              # e86f580000                          call    NTOHS
              # 6689442450                          mov     [rsp+98h+Length], ax
              # 488b5c2440                          mov     rbx, [rsp+98h+var_58]
              # 4883c302                            add     rbx, 2
              # 66b90100                            mov     cx, 1
              # e858580000                          call    NTOHS
              # 4c8bcb                              mov     r9, rbx
              # 440fb7442450                        movzx   r8d, [rsp+98h+Length]
              # 0fb7d0                              movzx   edx, ax
              # 488b4c2438                          mov     rcx, [rsp+98h+var_60]
              # e862d5ffff                          call    Dhcp6AppendOption
    variant2:
      code:
        and:
          - pattern: 4b8b44c5..4183c2..49ffc00fb748..66c1c1..0fb7c14403d04d3bc672..418dba........8bcfe8
              # 4b8b44c500                          mov     rax, [r13+r8*8+0]
              # 4183c204                            add     r10d, 4
              # 49ffc0                              inc     r8
              # 0fb74802                            movzx   ecx, word ptr [rax+2]
              # 66c1c108                            rol     cx, 8
              # 0fb7c1                              movzx   eax, cx
              # 4403d0                              add     r10d, eax
              # 4d3bc6                              cmp     r8, r14
              # 72e1                                jb      short loc_417D
              # 418dba00040000                      lea     edi, [r10+400h]
              # 8bcf                                mov     ecx, edi; AllocationSize
              # e8b20e0000                          call    AllocateZeroPool
          - pattern: 450fb704244d8d4c24..6641c1c0..ba........488bc8e8
              # 450fb70424                          movzx   r8d, word ptr [r12]
              # 4d8d4c2402                          lea     r9, [r12+2]
              # 6641c1c008                          rol     r8w, 8
              # ba00010000                          mov     edx, 100h
              # 488bc8                              mov     rcx, rax
              # e8dad5ffff                          call    Dhcp6AppendOption
